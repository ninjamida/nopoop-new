!!! HIGHLY EXPERIMENTAL - LIMITED TESTING SO FAR - USE AT YOUR OWN RISK !!!

--== START PRINT ==--
START_PRINT EXTRUDER_TEMP=[nozzle_temperature_initial_layer] BED_TEMP=[bed_temperature_initial_layer_single]
SET_PRINT_STATS_INFO TOTAL_LAYER=[total_layer_count]
T{initial_no_support_extruder}


--== MATERIAL CHANGE ==--

SET_FAN_SPEED FAN=fanM106 SPEED=0
SET_VELOCITY_LIMIT ACCEL=[travel_acceleration]
G1 X{x_after_toolchange} Y{y_after_toolchange} F18000
G1 Z{z_after_toolchange}
{if flush_length > 0}
_COLOR_CHANGE_PARAMS NOPOOP_MODE=0 NEW_MATERIAL_TEMPERATURE=[new_filament_temp]
T[next_extruder]
_GOTO_TRASH
M104 S[new_filament_temp]
SET_FAN_SPEED FAN=fanM106 SPEED=0
_DISABLE_SENSOR
; FLUSH_START
{if flush_length_1 == 0}
G1 E2 F{old_filament_e_feedrate / 2}
G1 E{flush_length + old_retract_length_toolchange - 2} F{old_filament_e_feedrate}
SET_FAN_SPEED FAN=fanM106 SPEED=1
G4 P4000
M400
G1 E-1 F{old_filament_e_feedrate / 2}
_SBROS_TRASH
SET_FAN_SPEED FAN=fanM106 SPEED=0
{else}
G1 E2 F{old_filament_e_feedrate / 2}
G1 E{flush_length_1 + old_retract_length_toolchange - 2} F{old_filament_e_feedrate}
SET_FAN_SPEED FAN=fanM106 SPEED=1
G4 P4000
M400
G1 E-1 F{old_filament_e_feedrate / 2}
_SBROS_TRASH
SET_FAN_SPEED FAN=fanM106 SPEED=0
{if flush_length_2 > 0}
_GOTO_TRASH_STANDARD
G1 E2 F{old_filament_e_feedrate / 2}
G1 E{flush_length_2 - 1} F{old_filament_e_feedrate}
SET_FAN_SPEED FAN=fanM106 SPEED=1
G4 P4000
M400
G1 E-1 F{old_filament_e_feedrate / 2}
_SBROS_TRASH
SET_FAN_SPEED FAN=fanM106 SPEED=0
{endif}
{if flush_length_3 > 0}
_GOTO_TRASH_STANDARD
G1 E2 F{old_filament_e_feedrate / 2}
G1 E{flush_length_3 - 1} F{old_filament_e_feedrate}
SET_FAN_SPEED FAN=fanM106 SPEED=1
G4 P4000
M400
G1 E-1 F{old_filament_e_feedrate / 2}
_SBROS_TRASH
SET_FAN_SPEED FAN=fanM106 SPEED=0
{endif}
{if flush_length_4 > 0}
_GOTO_TRASH_STANDARD
G1 E2 F{old_filament_e_feedrate / 2}
G1 E{flush_length_4 - 1} F{old_filament_e_feedrate}
SET_FAN_SPEED FAN=fanM106 SPEED=1
G4 P4000
M400
G1 E-1 F{old_filament_e_feedrate / 2}
_SBROS_TRASH
SET_FAN_SPEED FAN=fanM106 SPEED=0
{endif}
{endif}
{if 1 - old_retract_length_toolchange < -2}
G1 E-2 F{old_filament_e_feedrate / 2}
G1 E{1 - old_retract_length_toolchange + 2} F{old_filament_e_feedrate}
{endif}
{if 1 - old_retract_length_toolchange >= -2 and 1 - old_retract_length_toolchange < 0}
G1 E{1 - old_retract_length_toolchange} F{old_filament_e_feedrate / 2}
{endif}
{if 1 - old_retract_length_toolchange > 0 and 1 - old_retract_length_toolchange <= 2}
G1 E{1 - old_retract_length_toolchange} F{old_filament_e_feedrate / 2}
{endif}
{if 1 - old_retract_length_toolchange > 2}
G1 E2 F{old_filament_e_feedrate / 2}
G1 E{1 - old_retract_length_toolchange - 2} F{old_filament_e_feedrate}
{endif}
; FLUSH_END
_ENABLE_SENSOR
M109 S[new_filament_temp]
G1 X{x_after_toolchange} Y{y_after_toolchange} F18000
G1 Z{z_after_toolchange}
{else}
_COLOR_CHANGE_PARAMS NOPOOP_MODE=1 NEW_MATERIAL_TEMPERATURE=[new_filament_temp]
T[next_extruder]
M109 S[new_filament_temp]
{endif}
{if layer_num == 0}
SET_VELOCITY_LIMIT ACCEL=[initial_layer_acceleration]
{else}
SET_VELOCITY_LIMIT ACCEL=[default_acceleration]
{endif}{if layer_num < close_fan_the_first_x_layers[next_extruder]}
SET_FAN_SPEED FAN=fanM106 SPEED=0
{elsif layer_num >= full_fan_speed_layer[next_extruder] - 1}
SET_FAN_SPEED FAN=fanM106 SPEED={ fan_min_speed[next_extruder] / 100}
{else}
SET_FAN_SPEED FAN=fanM106 SPEED={ fan_min_speed[next_extruder] * (layer_num - close_fan_the_first_x_layers[next_extruder] + 1) / (full_fan_speed_layer[next_extruder] - close_fan_the_first_x_layers[next_extruder]) / 100}
{endif}